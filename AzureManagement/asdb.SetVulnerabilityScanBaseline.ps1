<#Script Purpose: Update SQL vulnerability scan baseline - in order to prevent excess alert emails

reference:
Set-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline
https://docs.microsoft.com/en-us/powershell/module/az.sql/Set-azSqlDatabaseVulnerabilityAssessmentRuleBaseline?view=azps-4.2.0
#>

$rgName = 'resource group name'
$asdbName = 'name of azure sql database'
$serverName = 'logical azure sql server name'
$ruleId = 'rule id from alert email'

[string[][]] $ruleDef =  @( 
    'ClientIPAddress_2021-04-16_04:11:13',
    'ClientIPAddress_2020-10-08_09:31:08',
    'ClientIPAddress_2019-12-10_04:32:32',
)

#retrieve any existing baseline rules and add to the new list of baseline rules ( within $ruleDef variable )
#-RuleAppliesToMaster is used for VA

$ruleDef +=
    Get-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline `
             -ResourceGroupName $rgName `
             -ServerName $serverName  `
             -DatabaseName $asdbName `
             -RuleId $ruleId -RuleAppliesToMaster  `
    | Select-Object  -ExpandProperty BaselineResult 
    | Select-Object -ExpandProperty Result

#remove any duplicates
$ruleDef  | Select-Object -Unique

#update the baseline rules list with the newly built list ( within $ruleDef variable )
Set-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline `
                 -ResourceGroupName $rgName `
                 -ServerName $serverName `
                 -DatabaseName $asdbName `
                 -RuleId $ruleId  -RuleAppliesToMaster `
                 -BaselineResult $ruleDef  

<#
Clear-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline `
-ResourceGroupName $rgName `
-ServerName $serverName `
-DatabaseName $asdbName  -RuleAppliesToMaster -RuleId $ruleId
#>
